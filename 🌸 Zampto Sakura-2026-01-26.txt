// ==UserScript==
// @name         ğŸŒ¸ Zampto Sakura
// @namespace    ZAMPTO-RENEW
// @version      2.0
// @description  è‡ªåŠ¨ç›‘æ§ç»­æœŸæ—¶é—´ï¼Œæ‰§è¡Œç»­æœŸï¼ˆä¼˜åŒ– Docker Firefox é•¿æ—¶é—´è¿è¡Œï¼‰
// @author       ğŸ‘¸ğŸ»æ´›æ€ğŸ‘¸ğŸ»
// @match        https://dash.zampto.net/server?id=2712
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    //===========================================================================
    //  âš™ï¸ æ ¸å¿ƒé…ç½®
    //===========================================================================
    const RENEW_THRESHOLD_MINS = 30;     // å°‘äº30åˆ†é’Ÿæ—¶è§¦å‘ç»­æœŸ
    const CHECK_INTERVAL = 3000;         // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡
    const SUCCESS_CHECK_TIMEOUT = 40000; // 40ç§’è¶…æ—¶
    const SUCCESS_TIME = 2879;           // æˆåŠŸæ ‡å‡†: 2879åˆ†é’Ÿ (1d 23h 59m) - ä¸¥æ ¼åˆ¤å®š
    const MAX_LOGS = 50;
    const STORAGE_KEY = 'zm_sakura_v2';
    const STATE_KEY = 'zm_sakura_state';

    // æŒä¹…åŒ–çŠ¶æ€
    let state = GM_getValue(STATE_KEY, {
        isRenewing: false,
        waitingForTurnstile: false,
        renewalStartTime: 0,
        checkCount: 0
    });

    let data = GM_getValue(STORAGE_KEY, {
        logs: [],
        isPaused: false,
        lastSuccessDate: '--'
    });

    function saveState() {
        GM_setValue(STATE_KEY, state);
    }

    //===================== å·¥å…·å‡½æ•° ======================//
    const getBeijingTime = () => {
        const d = new Date();
        const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
        return new Date(utc + (3600000 * 8));
    };

    function parseTimeToMinutes(text) {
        try {
            let total = 0;
            const d = text.match(/(\d+)\s*day/);
            const h = text.match(/(\d+)\s*h/);
            const m = text.match(/(\d+)\s*m/);
            if (d) total += parseInt(d[1]) * 1440;
            if (h) total += parseInt(h[1]) * 60;
            if (m) total += parseInt(m[1]);
            return total;
        } catch (e) {
            return 0;
        }
    }

    function formatMinutes(mins) {
        const d = Math.floor(mins / 1440);
        const h = Math.floor((mins % 1440) / 60);
        const m = mins % 60;
        return `${d}d ${h}h ${m}m`;
    }

    function calculateExpiryDate(minutesLeft) {
        const date = getBeijingTime();
        date.setMinutes(date.getMinutes() + minutesLeft);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function checkTurnstileStable() {
        const cfInput = document.querySelector('input[name="cf-turnstile-response"]');
        if (cfInput && cfInput.value && cfInput.value.length > 20) return 'completed';
        const cfWidget = document.querySelector('iframe[src*="challenges.cloudflare.com"]');
        if (cfWidget) return 'pending';
        return 'none';
    }

    //===========================================================================
    //  ğŸŒ¸ UI é¢æ¿
    //===========================================================================
    const UI = {
        init() {
            GM_addStyle(`
                #zm-panel {
                    position: fixed; bottom: 15px; right: 15px; width: 260px;
                    background: rgba(255, 255, 255, 0.98); color: #444;
                    z-index: 99999; border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(255, 183, 178, 0.4);
                    font-family: system-ui, -apple-system, sans-serif;
                    font-size: 12px; border: 1px solid #ffd1d1;
                }
                #zm-header {
                    padding: 8px 12px; background: linear-gradient(135deg, #ff9a9e 0%, #ffc3a0 100%);
                    border-radius: 10px 10px 0 0; color: #fff; font-weight: 600;
                    display: flex; justify-content: space-between; align-items: center;
                    font-size: 13px;
                }
                #zm-content { padding: 10px; }
                .zm-row { margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
                .zm-label { color: #666; font-size: 11px; white-space: nowrap; }
                .zm-val {
                    font-family: "SF Mono", monospace;
                    font-weight: bold; font-size: 11px;
                    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;
                }
                .status-running { color: #00b894; font-size: 12px; }
                .status-renewing { color: #fdcb6e; animation: pulse 1.5s infinite; font-size: 12px; }
                .status-verifying { color: #74b9ff; animation: pulse 1s infinite; font-size: 12px; }
                @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
                .zm-btn-group { display: flex; gap: 6px; margin-top: 10px; }
                .zm-btn {
                    flex: 1; padding: 6px 0; border: none; border-radius: 5px;
                    cursor: pointer; color: white; font-weight: 600; font-size: 11px;
                    transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    white-space: nowrap;
                }
                .btn-start { background: linear-gradient(to right, #00b894, #55efc4); }
                .btn-pause { background: linear-gradient(to right, #ff7675, #fab1a0); }
                .btn-run { background: linear-gradient(to right, #6c5ce7, #a29bfe); }
                .btn-clear { background: #dfe6e9; color: #636e72; }
                #zm-logs {
                    height: 120px; overflow-y: scroll; background: #ffffff;
                    border: 2px solid #fce4ec; border-radius: 8px; padding: 6px;
                    margin-top: 10px; font-family: monospace; font-size: 10px;
                    box-shadow: inset 0 2px 6px rgba(0,0,0,0.02);
                }
                .log-row {
                    margin-bottom: 4px; line-height: 1.3;
                    border-bottom: 1px dashed #fce4ec; padding-bottom: 2px;
                    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                }
                .log-time { color: #8d6e63; margin-right: 5px; font-size: 9px; }
                .log-msg-success { color: #43a047; font-weight: bold; }
                .log-msg-warn { color: #fb8c00; }
                .log-msg-info { color: #1e88e5; }
                .log-msg-error { color: #e74c3c; font-weight: bold; }
                #zm-logs::-webkit-scrollbar { width: 3px; }
                #zm-logs::-webkit-scrollbar-thumb { background: #ffb7b2; border-radius: 2px; }
            `);

            const panel = document.createElement('div');
            panel.id = 'zm-panel';
            panel.innerHTML = `
                <div id="zm-header">
                    <span>ğŸŒ¸ Zampto Sakura v2.0</span>
                    <span id="zm-status" class="status-running">âš¡ è¿è¡Œä¸­</span>
                </div>
                <div id="zm-content">
                    <div class="zm-row">
                        <span class="zm-label">ğŸš€ è¿è¡Œæ—¥æœŸ</span>
                        <span id="zm-run-date" class="zm-val" style="color: #6c5ce7;">${getBeijingTime().toISOString().split('T')[0]}</span>
                    </div>
                    <div class="zm-row">
                        <span class="zm-label">ğŸ“… ä¸‹æ¬¡ç»­æœŸ</span>
                        <span id="zm-next-renew" class="zm-val" style="color: #00b894;">--</span>
                    </div>
                    <div class="zm-row">
                        <span class="zm-label">â³ åˆ©ç”¨æœŸé™</span>
                        <span id="zm-expiry" class="zm-val" style="color: #fd79a8;">--</span>
                    </div>
                    <div class="zm-row">
                        <span class="zm-label">âœ… ç»­æœŸç»“æœ</span>
                        <span id="zm-result" class="zm-val" style="color: ${data.lastSuccessDate === '--' ? '#fdcb6e' : '#00b894'};">${data.lastSuccessDate === '--' ? 'ç­‰å¾…ä¸­' : 'âœ… æˆåŠŸ (' + data.lastSuccessDate + ')'}</span>
                    </div>

                    <div class="zm-btn-group">
                        <button id="zm-toggle-btn" class="zm-btn ${data.isPaused ? 'btn-start' : 'btn-pause'}">
                            ${data.isPaused ? 'â–¶ å¯åŠ¨' : 'â¸ æš‚åœ'}
                        </button>
                        <button id="zm-run-btn" class="zm-btn btn-run">ğŸš€ æ‰‹åŠ¨ç»­æœŸ</button>
                        <button id="zm-clear-btn" class="zm-btn btn-clear">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div id="zm-logs"></div>
                </div>
            `;
            document.body.appendChild(panel);

            document.getElementById('zm-toggle-btn').onclick = () => {
                data.isPaused = !data.isPaused;
                GM_setValue(STORAGE_KEY, data);
                location.reload();
            };

            document.getElementById('zm-clear-btn').onclick = () => {
                data.logs = [];
                GM_setValue(STORAGE_KEY, data);
                UI.renderLogs();
                UI.log("ğŸŒ¸ Zampto Sakura å·²å¯åŠ¨", 'success');
            };

            document.getElementById('zm-run-btn').onclick = () => {
                UI.log(`ğŸ–±ï¸ æ‰‹åŠ¨ç»­æœŸ`, 'warn');
                clickRenewButton();
            };

            UI.renderLogs();
        },

        log(msg, type = 'info') {
            if (data.logs.length > 0 && data.logs[0].msg === msg) return;
            const time = getBeijingTime().toLocaleTimeString('en-GB', { hour12: false });
            data.logs.unshift({ time, msg, type });
            if (data.logs.length > MAX_LOGS) data.logs = data.logs.slice(0, MAX_LOGS);
            GM_setValue(STORAGE_KEY, data);
            UI.renderLogs();
        },

        renderLogs() {
            const container = document.getElementById('zm-logs');
            if (container) {
                container.innerHTML = data.logs.map(l =>
                    `<div class="log-row"><span class="log-time">[${l.time}]</span> <span class="log-msg-${l.type}">${l.msg}</span></div>`
                ).join('');
            }
        },

        updateStatus(statusText, statusClass = 'status-running') {
            const el = document.getElementById('zm-status');
            if (el) { el.textContent = statusText; el.className = statusClass; }
        },

        updateNextRenew(text) {
            const el = document.getElementById('zm-next-renew');
            if (el) { el.textContent = text; el.style.color = '#00b894'; }
        },

        updateExpiry(date) {
            const el = document.getElementById('zm-expiry');
            if (el) { el.textContent = date; el.style.color = '#fd79a8'; }
        },

        updateResult(result) {
            const el = document.getElementById('zm-result');
            if (el) {
                el.textContent = result;
                if (result.includes('æˆåŠŸ') || result.includes('âœ…')) el.style.color = '#00b894';
                else if (result.includes('å¤±è´¥') || result.includes('âŒ')) el.style.color = '#e74c3c';
                else if (result.includes('è¶…æ—¶') || result.includes('â±ï¸')) el.style.color = '#ff7675';
                else el.style.color = '#fdcb6e';
            }
        }
    };

    //===========================================================================
    //  ğŸš€ ç»­æœŸåŠŸèƒ½
    //===========================================================================
    function clickRenewButton() {
        if (state.isRenewing) {
            UI.log("âš ï¸ ç»­æœŸè¿›è¡Œä¸­ï¼Œè¯·ç¨å€™", 'warn');
            return false;
        }

        const renewBtn = Array.from(document.querySelectorAll('span'))
            .find(span => {
                const icon = span.querySelector('i.fa-sync');
                return icon && span.textContent.includes('Renew Server');
            });

        if (!renewBtn) {
            UI.log("âŒ æœªæ‰¾åˆ°ä¸»ç•Œé¢ç»­æœŸæŒ‰é’®", 'error');
            return false;
        }

        state.isRenewing = true;
        state.waitingForTurnstile = true;
        state.renewalStartTime = Date.now();
        state.checkCount = 0;
        saveState();

        UI.log("ğŸš€ ç‚¹å‡»ç»­æœŸï¼Œç­‰å¾…éªŒè¯...", 'warn');
        UI.updateStatus("ğŸ¤– éªŒè¯ä¸­", "status-verifying");
        UI.updateResult("äººæœºéªŒè¯...");

        renewBtn.click();
        return true;
    }

    function handleTurnstileSuccess() {
        UI.log("âœ¨ éªŒè¯é€šè¿‡ï¼Œç­‰å¾…è‡ªåŠ¨æäº¤...", "success");
        state.waitingForTurnstile = false;
        saveState();
        UI.updateStatus("ğŸ”„ ç¡®è®¤ä¸­", "status-renewing");
    }

    function handleSuccess() {
        const successDate = getBeijingTime().toISOString().split('T')[0];
        data.lastSuccessDate = successDate;
        GM_setValue(STORAGE_KEY, data);

        UI.log(`ğŸ‰ ç»­æœŸæˆåŠŸï¼`, 'success');
        UI.updateStatus("âš¡ è¿è¡Œä¸­", "status-running");
        UI.updateResult(`âœ… æˆåŠŸ (${successDate})`);

        state.isRenewing = false;
        state.checkCount = 0;
        state.renewalStartTime = 0;
        saveState();
    }

    //===========================================================================
    //  â° ä¸»ç›‘æ§å¾ªç¯
    //===========================================================================
    function monitorTime() {
        if (data.isPaused) return;

        // 1. Cloudflare éªŒè¯æµç¨‹
        if (state.isRenewing && state.waitingForTurnstile) {
            const cfStatus = checkTurnstileStable();
            if (cfStatus === 'completed') {
                handleTurnstileSuccess();
                return;
            }
            if (Date.now() - state.renewalStartTime > 180000) {
                UI.log("â±ï¸ éªŒè¯è¶…æ—¶ï¼Œé‡ç½®çŠ¶æ€", "error");
                state.isRenewing = false;
                state.waitingForTurnstile = false;
                state.renewalStartTime = 0;
                saveState();
                UI.updateStatus("âš¡ è¿è¡Œä¸­");
                location.reload();
            }
            return;
        }

        // 2. å¸¸è§„æ—¶é—´ç›‘æ§
        const timeEl = document.getElementById('nextRenewalTime');
        if (!timeEl) return;

        const timeText = timeEl.innerText.trim();
        const currentMins = parseTimeToMinutes(timeText);

        UI.updateExpiry(calculateExpiryDate(currentMins));

        const nextRenewMins = currentMins - RENEW_THRESHOLD_MINS;
        if (nextRenewMins > 0) {
            UI.updateNextRenew(formatMinutes(nextRenewMins));
        } else {
            UI.updateNextRenew("ç«‹å³æ‰§è¡Œ");
        }

        // ç»­æœŸä¸­æ£€æµ‹
        if (state.isRenewing && !state.waitingForTurnstile) {
            const elapsed = Date.now() - state.renewalStartTime;
            state.checkCount++;

            if (currentMins >= SUCCESS_TIME) { // ä¸¥æ ¼åˆ¤å®š
                handleSuccess();
            }
            else if (elapsed >= SUCCESS_CHECK_TIMEOUT) {
                UI.log(`âŒ ç»­æœŸå¤±è´¥ (å½“å‰: ${formatMinutes(currentMins)})`, 'error');
                UI.updateStatus("âš¡ è¿è¡Œä¸­", "status-running");
                UI.updateResult("âŒ å¤±è´¥");
                state.isRenewing = false;
                state.checkCount = 0;
                state.renewalStartTime = 0;
                saveState();
                setTimeout(() => { UI.log("ğŸ”„ å‡†å¤‡é‡è¯•", 'info'); }, 300000);
            }
        }
        else if (currentMins > 0 && currentMins <= RENEW_THRESHOLD_MINS) {
            UI.log(`âš¡ è§¦å‘ç»­æœŸ (å‰©ä½™ ${formatMinutes(currentMins)})`, 'warn');
            clickRenewButton();
        }
    }

    //===========================================================================
    //  ğŸ›¡ï¸ é”™è¯¯å¤„ç†
    //===========================================================================
    window.addEventListener('error', function(e) {
        console.error('[Zampto Sakura] æ•è·é”™è¯¯:', e.error);
        if (state.isRenewing) {
            state.isRenewing = false;
            state.waitingForTurnstile = false;
            saveState();
        }
    });

    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && !data.isPaused) {
            setTimeout(monitorTime, 1000);
        }
    });

    //===========================================================================
    //  ğŸ¬ åˆå§‹åŒ–
    //===========================================================================
    UI.init();

    if (!data.isPaused) {
        if (state.isRenewing) {
            const timeEl = document.getElementById('nextRenewalTime');
            let alreadySuccess = false;
            if (timeEl) {
                const currentMins = parseTimeToMinutes(timeEl.innerText.trim());
                if (currentMins >= SUCCESS_TIME) { // ä¸¥æ ¼åˆ¤å®š
                    handleSuccess();
                    alreadySuccess = true;
                }
            }

            if (!alreadySuccess) {
                if (state.waitingForTurnstile) {
                    UI.updateStatus("ğŸ¤– éªŒè¯ä¸­", "status-verifying");
                } else {
                    UI.updateStatus("ğŸ”„ ç»­æœŸä¸­", "status-renewing");
                    UI.log(`ğŸ”„ é¡µé¢åˆ·æ–°ï¼Œæ­£åœ¨éªŒè¯ç»“æœ...`, 'info');
                }
            }
        } else {
            if (data.logs.length === 0 || !data.logs.some(l => l.msg.includes('Sakura å·²å¯åŠ¨'))) {
                UI.log("ğŸŒ¸ Zampto Sakura v2.0 å·²å¯åŠ¨", 'success');
            }
        }
        setInterval(monitorTime, CHECK_INTERVAL);
        setTimeout(monitorTime, 1000);
    } else {
        UI.log("â¸ï¸ åŠ©æ‰‹å·²æš‚åœ", 'warn');
        UI.updateStatus("â›” å·²æš‚åœ");
    }
})();