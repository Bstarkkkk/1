// ==UserScript==
// @name         ğŸŒ¸ FreeMCHost Sakura
// @namespace    FREEMC-RENEW
// @version      2.0
// @description  ä¸€æ’ä¸‰æŒ‰é’®å¸ƒå±€ï¼Œæ–°å¢è¿è¡Œæ—¥æœŸä¸ç»“æœæ˜¾ç¤ºï¼Œä¼˜åŒ–æ–‡æ¡ˆä¸Emojiã€‚
// @author       æ´›æ€
// @match        https://freemchost.com/renew?id=*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const CONFIG = {
        DEFAULT_WAIT: 15,
        KEY: 'freemc_v55_storage',
        SERVER_ID: new URLSearchParams(window.location.search).get('id') || "772566828"
    };

    function getStoredData() {
        let stored = GM_getValue(CONFIG.KEY, null);
        if (!stored || typeof stored !== 'object') {
            const defaultData = { logs: [], nextAction: 0, isPaused: false, lastSyncAction: 0, lastClickStamp: 0, lastResult: 'ç­‰å¾…ä¸­...' };
            GM_setValue(CONFIG.KEY, defaultData);
            return defaultData;
        }
        if (!Array.isArray(stored.logs)) stored.logs = [];
        return stored;
    }

    let data = getStoredData();
    let isSyncing = false;
    let pageSyncAttempted = false;

    function parseExpiryToMinutes() {
        const el = document.getElementById('session-remaining');
        if (!el) return 0;
        const text = el.innerText;
        let totalMinutes = 0;
        const hMatch = text.match(/(\d+)h/);
        const mMatch = text.match(/(\d+)m/);
        if (hMatch) totalMinutes += parseInt(hMatch[1]) * 60;
        if (mMatch) totalMinutes += parseInt(mMatch[1]);
        return totalMinutes;
    }

    async function fetchServerTime() {
        if (isSyncing) return;
        let token = "";
        try { token = window.turnstileToken || (typeof turnstile !== 'undefined' ? turnstile.getResponse() : ""); } catch(e) {}
        if (!token) return;
        isSyncing = true;
        UI.log("ğŸ“¡ æ­£åœ¨åŒæ­¥æœåŠ¡å™¨å†·å´çŠ¶æ€...", 'info');
        try {
            const response = await fetch(`/api/renew_session?server_id=${CONFIG.SERVER_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest' },
                body: 'turnstile_token=' + encodeURIComponent(token)
            });
            const res = await response.json();
            const msg = res.message || "";
            const match = msg.match(/(\d+)\s*min/);
            if (match) {
                const mins = parseInt(match[1]);
                data.nextAction = Date.now() + (mins * 60 * 1000);
                data.lastSyncAction = data.nextAction;
                GM_setValue(CONFIG.KEY, data);
                UI.log(`âœ… åŒæ­¥æˆåŠŸï¼šå‰©ä½™å†·å´ ${mins} åˆ†é’Ÿ`, 'success');
            } else if (res.success || msg.includes("successfully")) {
                UI.log("ğŸ‰ åŒæ­¥ï¼šæ£€æµ‹ç°åœ¨å³å¯ç»­æœŸï¼", 'success');
                data.nextAction = Date.now();
                data.lastSyncAction = data.nextAction;
                GM_setValue(CONFIG.KEY, data);
            }
        } catch (err) { UI.log("âŒ æ¥å£è¯·æ±‚å¤±è´¥", 'warn'); }
        finally { isSyncing = false; pageSyncAttempted = true; }
    }

    function check() {
        if (data.isPaused) {
            document.getElementById('zm-next-run').innerText = "å·²æš‚åœ";
            return;
        }

        const now = Date.now();
        const diff = data.nextAction - now;
        const el = document.getElementById('zm-next-run');
        const resEl = document.getElementById('zm-last-result');

        // æ›´æ–°åˆ©ç”¨æœŸé™æ˜¾ç¤º
        const expEl = document.getElementById('session-remaining');
        if (expEl) {
            document.getElementById('zm-expiry').innerText = expEl.innerText.replace(' remaining', '').trim();
        }

        // æ›´æ–°ç»­æœŸç»“æœæ˜¾ç¤º
        if (resEl) resEl.innerText = data.lastResult || "ç­‰å¾…ä¸­...";

        const isCooldownActive = (data.lastSyncAction === data.nextAction && diff > 0);
        const isClickCooling = (now - data.lastClickStamp < 60000);

        if (!pageSyncAttempted && !isCooldownActive && !isClickCooling && diff > 60000 && performance.now() > 10000) {
            fetchServerTime();
        }

        if (el) {
            const physicalLock = localStorage.getItem('zm_click_hard_lock') || 0;
            const isPhysicallyLocked = (now - physicalLock < 60000);

            if (data.nextAction > 0 && diff <= 0) {
                el.innerText = "ğŸš€ å°±ç»ª";
                const btn = document.getElementById('renewSessionBtn');

                if (btn && !btn.disabled && !window.isExecuting && performance.now() > 8000 && !isPhysicallyLocked) {
                    window.isExecuting = true;
                    const beforeMinutes = parseExpiryToMinutes();
                    UI.log(`ğŸš€ æ‰§è¡Œç»­æœŸç‚¹å‡»...`, 'success');
                    data.lastResult = "â³ æ­£åœ¨æ‰§è¡Œ...";

                    const stamp = Date.now();
                    data.lastClickStamp = stamp;
                    data.lastSyncAction = 0;
                    data.nextAction = stamp + (CONFIG.DEFAULT_WAIT * 60 * 1000);
                    localStorage.setItem('zm_click_hard_lock', stamp);
                    GM_setValue(CONFIG.KEY, data);

                    btn.click();

                    let checkCount = 0;
                    const resultTimer = setInterval(() => {
                        const afterMinutes = parseExpiryToMinutes();
                        checkCount++;
                        if (afterMinutes > beforeMinutes) {
                            const add = afterMinutes - beforeMinutes;
                            data.lastResult = `âœ… æˆåŠŸ(+${add}m)`;
                            UI.log(`ğŸŠ ç»­æœŸæˆåŠŸï¼å¢åŠ  ${add} åˆ†é’Ÿ`, 'success');
                            GM_setValue(CONFIG.KEY, data);
                            clearInterval(resultTimer);
                            setTimeout(() => location.reload(), 1500);
                        } else if (checkCount > 12) {
                            data.lastResult = "âŒ ç–‘ä¼¼å¤±è´¥";
                            UI.log("âš ï¸ å¯¿å‘½æœªå¢é•¿ï¼Œæ£€æŸ¥éªŒè¯ç ", 'warn');
                            GM_setValue(CONFIG.KEY, data);
                            clearInterval(resultTimer);
                            setTimeout(() => location.reload(), 2000);
                        }
                    }, 500);

                } else if (isPhysicallyLocked) {
                    el.innerText = "ğŸ”’ å†·å´ä¿æŠ¤";
                } else if (performance.now() <= 8000) {
                    el.innerText = "âš™ï¸ ç³»ç»Ÿé¢„çƒ­";
                }
            } else if (data.nextAction === 0) {
                el.innerText = "ğŸ’¤ ç­‰å¾…åŒæ­¥";
            } else {
                const m = Math.floor(diff/60000);
                const s = Math.floor((diff%60000)/1000);
                el.innerText = `${m}m ${s}s`;

                const sessionLock = sessionStorage.getItem('zm_refresh_lock');
                if (diff < 12000 && diff > 5000 && sessionLock !== data.nextAction.toString()) {
                    sessionStorage.setItem('zm_refresh_lock', data.nextAction.toString());
                    UI.log("ğŸ”„ é¢„çƒ­åˆ·æ–°...", 'warn');
                    setTimeout(() => location.reload(), 500);
                }
            }
        }
    }

    const UI = {
        init() {
            GM_addStyle(`
                #zm-panel{position:fixed;bottom:20px;right:20px;width:300px;background:#fff;z-index:1000000;border-radius:15px;box-shadow:0 8px 30px rgba(255,183,178,0.4);font-family:sans-serif;border:1px solid #ffd1d1;overflow:hidden}
                #zm-header{padding:12px;background:linear-gradient(135deg,#ff9a9e 0%,#ffc3a0 100%);color:#fff;font-weight:bold;text-align:center;font-size:14px}
                #zm-content{padding:15px}
                .zm-row{margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;font-size:13px}
                .zm-label{color:#7f8c8d}
                .zm-val{font-weight:bold;color:#2d3436;font-family:monospace}
                .zm-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
                .zm-btn{padding:8px 2px;background:#fff5f5;border:1px solid #ffb7b2;border-radius:8px;cursor:pointer;font-size:11px;color:#ff7675;text-align:center;transition:0.3s}
                .zm-btn:hover{background:#ff7675;color:#fff}
                #zm-logs{height:120px;overflow-y:auto;background:#fdfdfe;border:1px solid #fce4ec;border-radius:10px;padding:10px;font-size:11px;color:#636e72}
                .log-row{margin-bottom:5px;border-bottom:1px dashed #eee;padding-bottom:2px}
                .log-msg-success{color:#27ae60;font-weight:bold}
                .log-msg-warn{color:#e67e22;font-weight:bold}
                .log-msg-info{color:#2980b9}
            `);

            const today = new Date().toLocaleDateString();
            const p = document.createElement('div'); p.id = 'zm-panel';
            p.innerHTML = `
                <div id="zm-header">ğŸŒ¸ FreeMC Sakura v2.0</div>
                <div id="zm-content">
                    <div class="zm-row"><span class="zm-label">ğŸ“… è¿è¡Œæ—¥æœŸ</span><span class="zm-val">${today}</span></div>
                    <div class="zm-row"><span class="zm-label">â³ ä¸‹æ¬¡ç»­æœŸ</span><span id="zm-next-run" class="zm-val">--</span></div>
                    <div class="zm-row"><span class="zm-label">ğŸ”‹ åˆ©ç”¨æœŸé™</span><span id="zm-expiry" class="zm-val" style="color:#e17055">--</span></div>
                    <div class="zm-row"><span class="zm-label">ğŸ“Š ç»­æœŸç»“æœ</span><span id="zm-last-result" class="zm-val" style="color:#0984e3">ç­‰å¾…ä¸­...</span></div>

                    <div class="zm-btns">
                        <div id="btn-sync" class="zm-btn">ğŸ”„ åŒæ­¥</div>
                        <div id="btn-pause" class="zm-btn">${data.isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ'}</div>
                        <div id="btn-clear" class="zm-btn">ğŸ§¹ æ¸…ç©º</div>
                    </div>

                    <div id="zm-logs"></div>
                </div>`;
            document.body.appendChild(p);

            this.renderLogs();
            setTimeout(() => this.renderLogs(), 500);

            document.getElementById('btn-sync').onclick = () => { pageSyncAttempted = false; data.lastSyncAction = 0; localStorage.removeItem('zm_click_hard_lock'); fetchServerTime(); };
            document.getElementById('btn-pause').onclick = function() { data.isPaused = !data.isPaused; this.innerText = data.isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ'; GM_setValue(CONFIG.KEY, data); };
            document.getElementById('btn-clear').onclick = () => { data.logs = []; GM_setValue(CONFIG.KEY, data); document.getElementById('zm-logs').innerHTML = ''; };
        },
        renderLogs() {
            const c = document.getElementById('zm-logs');
            const d = getStoredData();
            if(c && d && d.logs) {
                c.innerHTML = d.logs.map(l => l ? `<div class="log-row"><span>[${l.time || '??'}]</span><span class="log-msg-${l.type || 'info'}">${l.msg || ''}</span></div>` : "").join('');
            }
        },
        log(msg, type = 'info') {
            if (!msg) return;
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
            let d = getStoredData();
            if (d.logs.length > 0 && d.logs[0].msg === msg) return;
            d.logs.unshift({ time, msg, type });
            if (d.logs.length > 30) d.logs.pop();
            GM_setValue(CONFIG.KEY, d);
            data.logs = d.logs;
            this.renderLogs();
        }
    };

    UI.init();
    setInterval(check, 1000);
})();