// ==UserScript==
// @name         ğŸŒ¸ Zampto ç»­æœŸåŠ©æ‰‹ (Log-Optimized Version)
// @namespace    ZAMPTO-RENEW-HELPER
// @version      2.6
// @description  ä¿ç•™ä¸Šä¸€ç‰ˆ Zampto æ ¸å¿ƒé€»è¾‘ï¼Œä»…ä¼˜åŒ–æ—¥å¿—æ‰“å°ä¸æ—¥å¿—åŒº UI
// @author       Gemini
// @match        https://dash.zampto.net/server?id=2711
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    //===========================================================================
    //  âš™ï¸ æ ¸å¿ƒé…ç½® (å®Œå…¨ä¿ç•™ä¸Šä¸€ç‰ˆ)
    //===========================================================================
    const CONFIG = {
        RENEW_THRESHOLD_MINS: 30,
        CHECK_INTERVAL: 10000,
        SERVER_ID: "2711",
        STORAGE_KEY: 'zm_sakura_log_v2'
    };

    let data = GM_getValue(CONFIG.STORAGE_KEY, {
        logs: [],
        isPaused: false
    });

    //===================== å·¥å…·å‡½æ•° ======================//
    const getBeijingTime = () => {
        const d = new Date();
        const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
        return new Date(utc + (3600000 * 8));
    };

    function parseTimeToMinutes(text) {
        try {
            let total = 0;
            const d = text.match(/(\d+)\s*day/);
            const h = text.match(/(\d+)\s*h/);
            const m = text.match(/(\d+)\s*m/);
            if (d) total += parseInt(d[1]) * 1440;
            if (h) total += parseInt(h[1]) * 60;
            if (m) total += parseInt(m[1]);
            return total;
        } catch (e) { return 0; }
    }

    function calculateExpiryDate(minutesLeft) {
        const date = getBeijingTime();
        date.setMinutes(date.getMinutes() + minutesLeft);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    //===========================================================================
    //  ğŸŒ¸ UI é¢æ¿ä¸æ—¥å¿—é€»è¾‘ (æ—¥å¿—éƒ¨åˆ†å‚è€ƒ Sakura)
    //===========================================================================
    const UI = {
        init() {
            GM_addStyle(`
                #zm-panel {
                    position: fixed; bottom: 20px; right: 20px; width: 280px;
                    background: rgba(255, 255, 255, 0.98); color: #444;
                    z-index: 99999; border-radius: 12px;
                    box-shadow: 0 5px 25px rgba(255, 183, 178, 0.5);
                    font-family: system-ui, -apple-system, sans-serif;
                    font-size: 13px; border: 1px solid #ffd1d1;
                }
                #zm-header {
                    padding: 10px 15px; background: linear-gradient(135deg, #ff9a9e 0%, #ffc3a0 100%);
                    border-radius: 12px 12px 0 0; color: #fff; font-weight: 600;
                    display: flex; justify-content: space-between; align-items: center;
                }
                #zm-content { padding: 12px; }
                .zm-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
                .zm-label { color: #666; font-size: 12px; }
                .zm-val { font-family: "SF Mono", monospace; font-weight: bold; color: #333; }
                .hl-date { color: #e17055; }

                .zm-btn-group { display: flex; gap: 8px; margin-top: 12px; }
                .zm-btn {
                    flex: 1; padding: 7px 0; border: none; border-radius: 6px;
                    cursor: pointer; color: white; font-weight: 600; font-size: 12px;
                    transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .btn-start { background: linear-gradient(to right, #00b894, #55efc4); }
                .btn-pause { background: linear-gradient(to right, #ff7675, #fab1a0); }
                .btn-run { background: linear-gradient(to right, #6c5ce7, #a29bfe); }
                .btn-clear { background: #dfe6e9; color: #636e72; border: 1px solid #b2bec3; }

                /* æ—¥å¿—åŒºåŸŸ - åŒæ­¥ Sakura æ ·å¼ */
                #zm-logs {
                    height: 140px; overflow-y: scroll; background: #ffffff;
                    border: 2px solid #fce4ec; border-radius: 10px; padding: 8px;
                    margin-top: 12px; font-family: monospace; font-size: 11px;
                    box-shadow: inset 0 2px 6px rgba(0,0,0,0.02);
                }
                .log-row { margin-bottom: 5px; line-height: 1.4; display: flex; border-bottom: 1px dashed #fce4ec; padding-bottom: 2px; }
                .log-time { color: #8d6e63; margin-right: 6px; flex-shrink: 0; }
                .log-msg-success { color: #43a047; font-weight: bold; }
                .log-msg-warn { color: #fb8c00; }
                .log-msg-info { color: #1e88e5; }
                #zm-logs::-webkit-scrollbar { width: 4px; }
                #zm-logs::-webkit-scrollbar-thumb { background: #ffb7b2; border-radius: 2px; }
            `);

            const panel = document.createElement('div');
            panel.id = 'zm-panel';
            panel.innerHTML = `
                <div id="zm-header">
                    <span>ğŸŒ¸ Zampto ç»­æœŸåŠ©æ‰‹</span>
                    <span id="zm-status">${data.isPaused ? 'â›” æš‚åœ' : 'âš¡ è¿è¡Œä¸­'}</span>
                </div>
                <div id="zm-content">
                    <div class="zm-row"><span class="zm-label">ğŸš€ è¿è¡Œæ—¥æœŸ</span><span class="zm-val">${getBeijingTime().toISOString().split('T')[0]}</span></div>
                    <div class="zm-row"><span class="zm-label">ğŸ“… ä¸‹æ¬¡ç»­æœŸ</span><span id="zm-next-run" class="zm-val" style="color:#a29bfe;">--</span></div>
                    <div class="zm-row"><span class="zm-label">â³ åˆ©ç”¨æœŸé™</span><span id="zm-expiry" class="zm-val hl-date">--</span></div>

                    <div class="zm-btn-group">
                        <button id="zm-toggle-btn" class="zm-btn ${data.isPaused ? 'btn-start' : 'btn-pause'}">${data.isPaused ? 'â–¶ ç»§ç»­' : 'â¸ æš‚åœ'}</button>
                        <button id="zm-run-btn" class="zm-btn btn-run">ğŸš€ è¿è¡Œ</button>
                        <button id="zm-clear-btn" class="zm-btn btn-clear">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div id="zm-logs"></div>
                </div>
            `;
            document.body.appendChild(panel);

            document.getElementById('zm-toggle-btn').onclick = () => { data.isPaused = !data.isPaused; GM_setValue(CONFIG.STORAGE_KEY, data); location.reload(); };
            document.getElementById('zm-clear-btn').onclick = () => { data.logs = []; GM_setValue(CONFIG.STORAGE_KEY, data); UI.renderLogs(); };
            document.getElementById('zm-run-btn').onclick = () => { executeRenewal(); };
            UI.renderLogs();
        },

        // --- æ—¥å¿—æ‰“å°é€»è¾‘: åŒæ­¥ Sakura é™å™ªä¸å»é‡ ---
        log(msg, type = 'info') {
            if (msg.includes('åŠ è½½æˆåŠŸ')) {
                const hasLoadedMsg = data.logs.some(l => l.msg.includes('åŠ è½½æˆåŠŸ'));
                if (hasLoadedMsg) return;
            }
            if (data.logs.length > 0 && data.logs[0].msg === msg) return;

            const time = getBeijingTime().toLocaleTimeString('en-GB', { hour12: false });
            data.logs.unshift({ time, msg, type });
            if (data.logs.length > 50) data.logs.pop();
            GM_setValue(CONFIG.STORAGE_KEY, data);
            UI.renderLogs();
        },

        renderLogs() {
            const container = document.getElementById('zm-logs');
            if(container) {
                container.innerHTML = data.logs.map(l =>
                    `<div class="log-row"><span class="log-time">[${l.time}]</span><span class="log-msg-${l.type || 'info'}">${l.msg}</span></div>`
                ).join('');
            }
        }
    };

    //===========================================================================
    //  ğŸš€ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å®Œå…¨ä¿ç•™ä¸Šä¸€ç‰ˆ)
    //===========================================================================

    function executeRenewal() {
        const btn = document.querySelector(`a[onclick*="handleServerRenewal(event, ${CONFIG.SERVER_ID})"]`);
        if (btn) {
            UI.log("å‘é€ç»­æœŸè¯·æ±‚...", 'warn');
            btn.click();
            UI.log("âœ… ç»­æœŸæŒ‡ä»¤å·²å‘é€", 'success');
        } else {
            UI.log("âŒ æœªæ‰¾åˆ°ç»­æœŸæŒ‰é’®", 'warn');
        }
    }

    function update() {
        if (data.isPaused) return;

        const timeEl = document.getElementById('nextRenewalTime');
        if (!timeEl) return;

        const timeText = timeEl.innerText.trim();
        const totalMins = parseTimeToMinutes(timeText);

        // 1. æ›´æ–°åˆ©ç”¨æœŸé™ (æ¨ç®—æ—¥æœŸ)
        document.getElementById('zm-expiry').innerText = calculateExpiryDate(totalMins);

        // 2. æ›´æ–°ä¸‹æ¬¡ç»­æœŸ (å€’è®¡æ—¶)
        const nextRunMins = totalMins - CONFIG.RENEW_THRESHOLD_MINS;
        if (nextRunMins <= 0) {
            document.getElementById('zm-next-run').innerText = "ç«‹å³æ‰§è¡Œ";
            executeRenewal();
        } else {
            const d = Math.floor(nextRunMins / 1440);
            const h = Math.floor((nextRunMins % 1440) / 60);
            const m = nextRunMins % 60;
            document.getElementById('zm-next-run').innerText = `${d}d ${h}h ${m}m`;
        }
    }

    // åˆå§‹åŒ–
    UI.init();
    if (!data.isPaused) {
        UI.log("ğŸŒ¸ Zampto åŠ©æ‰‹åŠ è½½æˆåŠŸ", 'success');
        setInterval(update, CONFIG.CHECK_INTERVAL);
        setTimeout(update, 1000);
    }
})();