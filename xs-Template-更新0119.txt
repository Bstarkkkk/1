// ==UserScript==
// @name         ğŸŒ¸ XServer VPSç»­æœŸåŠ©æ‰‹ (Sakura V2.0)
// @namespace    XSERVER-RENEW
// @version      2.0
// @description  XServer-VPSä¸“ç”¨ | ç²¾è‡´å°å·§UI | æŒ‰é’®ç½®é¡¶ | æ™ºèƒ½æ’æœŸ | è‡ªåŠ¨è¯†åˆ«ID | CFéªŒè¯å¢å¼º
// @match        https://secure.xserver.ne.jp/*
// @connect      api.telegram.org
// @connect      captcha-120546510085.asia-northeast1.run.app
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @run-at       document-idle
// ==/UserScript==

(async function() {
    'use strict';

    //===========================================================================
    //   âš™ï¸âš™ï¸âš™ï¸ ç”¨æˆ·é…ç½® âš™ï¸âš™ï¸âš™ï¸
    //===========================================================================
    const CONFIG = {
        EMAIL: "",
        PASSWORD: "",
        TG_TOKEN: "",
        TG_ID: "",
        CAPTCHA_API: "https://captcha-120546510085.asia-northeast1.run.app",
        LOGIN_URL: "https://secure.xserver.ne.jp/xapanel/login/xvps"
    };

    //===================== æ ¸å¿ƒçŠ¶æ€ç®¡ç† ======================//
    const STORE = {
        get logs() { return GM_getValue('xs_logs_v3', []); },
        set logs(val) { GM_setValue('xs_logs_v3', val.slice(-50)); },

        get lastRunDate() { return GM_getValue('xs_last_run_date', 'æ— è®°å½•'); },
        set lastRunDate(val) { GM_setValue('xs_last_run_date', val); },

        get nextRunDate() { return GM_getValue('xs_next_run_date', ''); },
        set nextRunDate(val) { GM_setValue('xs_next_run_date', val); },

        get lastResult() { return GM_getValue('xs_last_result', 'ç­‰å¾…è¿è¡Œ'); },
        set lastResult(val) { GM_setValue('xs_last_result', val); },

        get isPaused() { return GM_getValue('xs_is_paused', false); },
        set isPaused(val) { GM_setValue('xs_is_paused', val); },

        get forceRun() { return GM_getValue('xs_force_run', false); },
        set forceRun(val) { GM_setValue('xs_force_run', val); },

        get expiryDate() { return GM_getValue('xs_expiry_date', 'æœªçŸ¥'); },
        set expiryDate(val) { GM_setValue('xs_expiry_date', val); }
    };

    //===================== å·¥å…·å‡½æ•° ======================//
    const wait = ms => new Promise(r => setTimeout(r, ms));

    function formatDate(rawStr) {
        if (!rawStr) return "æœªçŸ¥";
        if (/^\d{4}-\d{2}-\d{2}$/.test(rawStr)) return rawStr;
        const match = rawStr.match(/(\d{4})[-./å¹´](\d{1,2})[-./æœˆ](\d{1,2})/);
        if (match) return `${match[1]}-${match[2].padStart(2,'0')}-${match[3].padStart(2,'0')}`;
        return rawStr;
    }

    function calculatePrevDay(dateStr) {
        try {
            const d = new Date(dateStr);
            d.setDate(d.getDate() - 1);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        } catch (e) { return null; }
    }

    function sendTg(text) {
        if (!CONFIG.TG_TOKEN || !CONFIG.TG_ID) return;
        const today = getBeijingDate().dateStr;
        let statusEmoji = "ğŸ“";
        if (text.includes("æˆåŠŸ")) statusEmoji = "âœ…";
        if (text.includes("ç­‰å¾…")) statusEmoji = "âš ï¸";
        if (text.includes("å¤±è´¥")) statusEmoji = "âŒ";

        const msg = `ğŸŒ¸ <b>XServer VPS ç»­æœŸåŠ©æ‰‹</b>\n\n` +
                    `ğŸš€ <b>è¿è¡Œæ—¥æœŸ:</b> ${today}\n` +
                    `ğŸ“… <b>ä¸‹æ¬¡ç»­æœŸ:</b> ${STORE.nextRunDate || 'æœªçŸ¥'}\n` +
                    `â³ <b>åˆ©ç”¨æœŸé™:</b> ${STORE.expiryDate}\n` +
                    `${statusEmoji} <b>ç»­æœŸç»“æœ:</b> ${text}\n` +
                    `ğŸ“§ <b>å½“å‰è´¦å·:</b> ${CONFIG.EMAIL}`;

        const url = `https://api.telegram.org/bot${CONFIG.TG_TOKEN}/sendMessage?chat_id=${CONFIG.TG_ID}&text=${encodeURIComponent(msg)}&parse_mode=HTML`;
        GM_xmlhttpRequest({ method: "GET", url: url, onerror: (e) => console.error("TG Fail", e) });
    }

    const getBeijingDate = () => {
        const d = new Date();
        const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
        const bjDate = new Date(utc + (3600000 * 8));
        return {
            full: bjDate,
            dateStr: `${bjDate.getFullYear()}-${String(bjDate.getMonth() + 1).padStart(2, '0')}-${String(bjDate.getDate()).padStart(2, '0')}`,
            hour: bjDate.getHours()
        };
    };

    async function ocrSolve(imgDataUrl) {
        return new Promise(resolve => {
            GM_xmlhttpRequest({
                method: "POST",
                url: CONFIG.CAPTCHA_API,
                headers: { "Content-Type": "text/plain" },
                data: imgDataUrl,
                onload: r => {
                    let match = r.responseText.match(/\d+/);
                    resolve(match ? match[0] : "");
                },
                onerror: () => resolve("")
            });
        });
    }

    function extractNextAllowedDate() {
        try {
            const bodyText = document.body.innerText;
            let match = bodyText.match(/(\d{4})[-./å¹´](\d{1,2})[-./æœˆ](\d{1,2})æ—¥?.*ã‹ã‚‰.*å¯èƒ½/);
            if (!match) match = bodyText.match(/åˆ©ç”¨ã‚’ç¶™ç¶šã•ã‚Œã‚‹å ´åˆã¯[ã€,\s]*(\d{4})[-./å¹´](\d{1,2})[-./æœˆ](\d{1,2})/);
            if (match) return formatDate(match[0]);
        } catch(e) { console.error("æ’æœŸæå–é”™è¯¯", e); }
        return null;
    }

    function extractExactExpiry() {
        try {
            const labelEl = Array.from(document.querySelectorAll('th, td, dt, dd, div')).find(el => el.innerText.includes("åˆ©ç”¨æœŸé™") && el.children.length === 0);
            if (labelEl && labelEl.parentElement) {
                const dateMatch = labelEl.parentElement.innerText.match(/20\d{2}[-./å¹´]\d{1,2}[-./æœˆ]\d{1,2}/);
                if (dateMatch) return formatDate(dateMatch[0]);
            }
            const classEl = document.querySelector(".contract__term");
            if (classEl && classEl.innerText.match(/20\d{2}/)) return formatDate(classEl.innerText.trim());
        } catch(e) { console.error("æ—¥æœŸæå–é”™è¯¯", e); }
        return null;
    }

    function extractNewExpiryFromConf() {
        try {
            const targetTh = Array.from(document.querySelectorAll('th')).find(th => th.innerText.includes('æ›´æ–°å¾Œã®åˆ©ç”¨æœŸé™'));
            if (targetTh && targetTh.nextElementSibling) return formatDate(targetTh.nextElementSibling.innerText.trim());
        } catch(e) { console.error("æ–°æ—¥æœŸæå–é”™è¯¯", e); }
        return null;
    }

    //===================== UI é¢æ¿ç³»ç»Ÿ (ğŸŒ¸ ç²¾è‡´å°å·§ç‰ˆ) ======================//
    const UI = {
        init() {
            GM_addStyle(`
                #kb-panel {
                    position: fixed; bottom: 15px; right: 15px;
                    width: 290px; /* ğŸŸ¢ å®½åº¦ç¼©å° */
                    background: linear-gradient(180deg, #fff0f5 0%, #fce4ec 100%);
                    color: #5d4037;
                    z-index: 9999999 !important;
                    border: 3px solid #f8bbd0;
                    border-radius: 14px;
                    padding: 10px; /* ğŸŸ¢ å†…è¾¹è·å‡å° */
                    font-family: sans-serif; font-size: 12px;
                    box-shadow: 0 6px 15px rgba(233, 30, 99, 0.15);
                }
                .kb-header {
                    font-weight: bold; color: #d81b60; margin-bottom: 8px;
                    border-bottom: 1px dashed #f48fb1; padding-bottom: 4px;
                    display: flex; justify-content: space-between; align-items: center;
                }
                .kb-info-row {
                    margin-bottom: 4px; padding: 3px 6px; /* ğŸŸ¢ è¡Œé—´è·å‡å° */
                    background: rgba(255,255,255,0.6);
                    border-radius: 5px;
                    border-left: 3px solid #f48fb1;
                    display: flex; justify-content: space-between; align-items: center;
                }
                .kb-label { font-weight: bold; color: #d81b60; margin-right: 5px; }
                .kb-val { font-family: monospace; font-weight: bold; color: #333; }

                #kb-logs {
                    height: 110px; /* ğŸŸ¢ æ—¥å¿—é«˜åº¦å‡å° */
                    overflow-y: auto;
                    background: #fff; border-radius: 8px;
                    padding: 6px; font-family: monospace;
                    border: 1px solid #fce4ec;
                    box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
                }

                .log-row { margin-bottom: 4px; line-height: 1.3; font-size: 11px; display: flex; align-items: flex-start; }
                .log-time { color: #8d6e63; margin-right: 5px; flex-shrink: 0; opacity: 0.7; }

                .log-msg-success { color: #43a047; font-weight: bold; }
                .log-msg-error { color: #e53935; font-weight: bold; }
                .log-msg-warn { color: #fb8c00; }
                .log-msg-info { color: #555; }

                .log-row.step-row {
                    background: #fce4ec; border-left: 3px solid #ec407a; padding: 2px 5px;
                    border-radius: 0 4px 4px 0; margin: 4px 0; color: #c2185b; font-weight: bold; align-items: center;
                }
                .log-row.step-row .log-time { display: none; }

                .kb-btn-group { display: flex; gap: 5px; margin-bottom: 6px; margin-top: 4px; }
                .kb-btn {
                    flex: 1; cursor: pointer; border: none; padding: 4px; /* ğŸŸ¢ æŒ‰é’®å˜å° */
                    border-radius: 5px; color: #fff; font-weight: bold; font-size: 11px;
                    transition: opacity 0.2s;
                }
                .kb-btn:hover { opacity: 0.9; }

                #kb-logs::-webkit-scrollbar { width: 4px; }
                #kb-logs::-webkit-scrollbar-thumb { background: #f48fb1; border-radius: 2px; }
            `);

            const panel = document.createElement('div');
            panel.id = 'kb-panel';
            panel.innerHTML = `
                <div class="kb-header">
                    <span>ğŸŒ¸ XServer-VPS V2.0</span>
                    <span id="kb-status" style="font-size:10px; background:#fff; padding:1px 4px; border-radius:4px; color:#d81b60;">Checking...</span>
                </div>
                <div id="kb-content">
                    <div class="kb-info-row">
                        <span class="kb-label">ğŸš€ è¿è¡Œæ—¥æœŸ:</span>
                        <span class="kb-val" id="xs-last-run">${STORE.lastRunDate}</span>
                    </div>
                    <div class="kb-info-row">
                        <span class="kb-label">ğŸ“… ä¸‹æ¬¡ç»­æœŸ:</span>
                        <span class="kb-val" id="xs-next-run" style="color:#8854d0;">${STORE.nextRunDate || 'ç­‰å¾…æ£€æµ‹'}</span>
                    </div>
                    <div class="kb-info-row">
                        <span class="kb-label">â³ åˆ©ç”¨æœŸé™:</span>
                        <span class="kb-val" id="xs-expiry" style="color:#d81b60;">${STORE.expiryDate}</span>
                    </div>
                    <div class="kb-info-row">
                        <span class="kb-label">ğŸ“ ç»­æœŸç»“æœ:</span>
                        <span class="kb-val" id="xs-result">${STORE.lastResult}</span>
                    </div>

                    <div class="kb-btn-group">
                        <button id="kb-manual" class="kb-btn" style="background:#6fd6ff">ğŸ” é‡ç½®</button>
                        <button id="kb-pause" class="kb-btn" style="background:#ffd54f; color:#5d4037;">${STORE.isPaused ? 'â–¶ æ¢å¤' : 'â¸ æš‚åœ'}</button>
                        <button id="kb-clear" class="kb-btn" style="background:#9e9e9e">ğŸ—‘ æ¸…ç©º</button>
                    </div>

                    <div id="kb-logs"></div>
                </div>
            `;
            document.body.appendChild(panel);

            document.getElementById('kb-manual').onclick = () => {
                if(confirm("ç¡®å®šè¦å¼ºåˆ¶é‡ç½®ä»»åŠ¡çŠ¶æ€å—ï¼Ÿ\nå°†æ¸…é™¤ä»Šå¤©çš„è¿è¡Œè®°å½•ã€‚")) {
                    STORE.forceRun = true;
                    STORE.lastRunDate = "ç­‰å¾…æ›´æ–°";
                    STORE.nextRunDate = "";
                    STORE.isPaused = false;
                    UI.log("æ‰‹åŠ¨é‡ç½®ä»»åŠ¡...", "step");
                    setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 500);
                }
            };
            document.getElementById('kb-pause').onclick = () => {
                STORE.isPaused = !STORE.isPaused;
                location.reload();
            };
            document.getElementById('kb-clear').onclick = () => {
                STORE.logs = [];
                UI.renderLogs();
            };

            UI.renderLogs();
            UI.updateStatus();

            setInterval(UI.updateCountdown, 60000);
            UI.updateCountdown();
        },

        log(msg, type = 'info') {
            const currentLogs = STORE.logs;
            if (currentLogs.length > 0 && currentLogs[0].m === msg) return;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            const logEntry = { t: timeStr, m: msg, c: type };

            console.log(`[${type}] ${msg}`);
            currentLogs.unshift(logEntry);
            STORE.logs = currentLogs;
            UI.renderLogs();
        },

        renderLogs() {
            const container = document.getElementById('kb-logs');
            if(!container) return;
            container.innerHTML = STORE.logs.map(l => {
                let rowClass = 'log-row';
                let icon = '';

                if (l.c === 'step') {
                    rowClass += ' step-row';
                    icon = 'ğŸ‘‰ ';
                    return `<div class="${rowClass}">${icon}${l.m}</div>`;
                }

                if (l.c === 'success') icon = 'ğŸŒ¸ ';
                if (l.c === 'error') icon = 'âŒ ';

                return `<div class="${rowClass}">
                    <span class="log-time">[${l.t}]</span>
                    <span class="log-msg-${l.c}">${icon}${l.m}</span>
                </div>`;
            }).join('');
        },

        updateStatus() {
            const statusEl = document.getElementById('kb-status');
            const btn = document.getElementById('kb-pause');
            if (STORE.isPaused) {
                if(statusEl) { statusEl.innerText = "â›” å·²æš‚åœ"; statusEl.style.color = "red"; }
                if(btn) { btn.innerText = "â–¶ æ¢å¤"; }
            } else {
                if(statusEl) { statusEl.innerText = "âš¡ è¿è¡Œä¸­"; statusEl.style.color = "#d81b60"; }
                if(btn) { btn.innerText = "â¸ æš‚åœ"; }
            }
        },

        updateExpiry(date) {
            const formatted = formatDate(date);
            STORE.expiryDate = formatted;
            const el = document.getElementById('xs-expiry');
            if(el) el.innerText = formatted;
        },

        updateResult(text) {
            STORE.lastResult = text;
            const el = document.getElementById('xs-result');
            if(el) el.innerText = text;
        },

        updateCountdown() {
            const el = document.getElementById('xs-next-run');
            if (!el || !STORE.nextRunDate) return;

            if (/^\d{4}-\d{2}-\d{2}$/.test(STORE.nextRunDate)) {
                const target = new Date(STORE.nextRunDate + ' 09:00:00').getTime();
                const now = new Date().getTime();
                const diff = target - now;

                if (diff > 0) {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    el.innerText = `${STORE.nextRunDate} (ä½™${hours}h ${mins}m)`;
                } else {
                    el.innerText = `${STORE.nextRunDate} (å‡†å¤‡è¿è¡Œ)`;
                }
            } else {
                el.innerText = STORE.nextRunDate;
            }
        }
    };

    //===================== é€»è¾‘æ§åˆ¶å™¨ ======================//

    UI.init();

    if (STORE.isPaused) {
        UI.log("è„šæœ¬å·²æš‚åœ", "warn");
        return;
    }

    const bjTime = getBeijingDate();
    const isLoginUrl = location.href.includes("/login/xvps");

    // --- è°ƒåº¦é€»è¾‘ ---
    if (isLoginUrl) {
        if (STORE.forceRun) {
            UI.log("ğŸš€ æŒ‡ä»¤: å¼ºåˆ¶è¿è¡Œ", "step");
            STORE.forceRun = false;
        } else {
            if (STORE.nextRunDate && bjTime.dateStr < STORE.nextRunDate) {
                UI.updateStatus();
                document.getElementById('kb-status').innerText = "â³ ç­‰å¾…é¢„çº¦";
                if (!STORE.logs[0] || !STORE.logs[0].m.includes("ä»Šæ—¥è·³è¿‡")) {
                    UI.log(`æœªåˆ°é¢„çº¦æ—¥ [${STORE.nextRunDate}]ï¼Œä»Šæ—¥è·³è¿‡ã€‚`, "info");
                }
                setTimeout(() => location.reload(), 3600 * 1000 * 4);
                return;
            }

            if (STORE.lastRunDate === bjTime.dateStr) {
                UI.updateStatus();
                document.getElementById('kb-status').innerText = "ğŸ’¤ ä»Šæ—¥å·²å®Œ";
                if (!STORE.logs[0] || !STORE.logs[0].m.includes("ä»»åŠ¡å·²å¤„ç†")) {
                    UI.log(`ä»Šæ—¥ (${bjTime.dateStr}) ä»»åŠ¡å·²å¤„ç†`, "success");
                }
                setTimeout(() => location.reload(), 3600 * 1000);
                return;
            }

            UI.log("â° å‡†å¤‡æ‰§è¡Œä»»åŠ¡...", "step");
        }
    }

    // --- ä¸šåŠ¡é€»è¾‘è·¯ç”± ---

    // â‘  ç™»å½•é¡µé¢
    if (location.href.includes("/login/xvps")) {
        UI.log("æ£€æµ‹åˆ°ç™»å½•é¡µï¼Œè‡ªåŠ¨ç™»å½•...", "step");
        await wait(1000);
        const emailInput = document.querySelector("input[name='memberid']");
        const passInput = document.querySelector("input[name='user_password']");
        const submitBtn = document.querySelector("input[type='submit']");
        if (emailInput && passInput && submitBtn) {
            emailInput.value = CONFIG.EMAIL;
            passInput.value = CONFIG.PASSWORD;
            submitBtn.click();
        }
    }

    // â‘¡ é¦–é¡µ (å«æˆåŠŸå¼¹çª—æ£€æµ‹)
    else if (location.href.includes("/xapanel/xvps/index")) {
        const successModalBtn = document.getElementById('modalDo__close');
        if (successModalBtn) {
            UI.log("ğŸ‰ æ£€æµ‹åˆ°æˆåŠŸå¼¹çª—ï¼", "success");
            UI.updateResult("âœ… ç»­æœŸæˆåŠŸï¼");

            const exactDate = extractExactExpiry();
            if (exactDate) {
                const nextRun = calculatePrevDay(exactDate);
                UI.updateExpiry(exactDate);
                if (nextRun) {
                    STORE.nextRunDate = nextRun;
                    STORE.lastRunDate = getBeijingDate().dateStr;
                    UI.log(`ğŸ“… ä¸‹æ¬¡æ’æœŸ: ${nextRun}`, "info");
                    sendTg(`âœ… ç»­æœŸæˆåŠŸï¼`);
                }
            } else {
                sendTg(`âœ… ç»­æœŸæˆåŠŸï¼`);
            }

            await wait(1000);
            successModalBtn.click();
            UI.log("ğŸ‘‹ æµç¨‹ç»“æŸï¼Œè¿”å›å¾…æœº...", "step");
            await wait(2000);
            location.href = CONFIG.LOGIN_URL;
            return;
        }

        UI.log("é¦–é¡µ: ç­‰å¾… [ç¨¼åƒä¸­]...", "step");

        let runningStatus = null;
        for (let i = 0; i < 120; i++) {
            const statusDivs = Array.from(document.querySelectorAll('div.on'));
            runningStatus = statusDivs.find(el => el.innerText.includes('ç¨¼åƒä¸­'));
            if (runningStatus) {
                UI.log("âœ… æœåŠ¡å™¨çŠ¶æ€æ­£å¸¸", "success");
                break;
            }
            await wait(1000);
        }

        if (!runningStatus) UI.log("âš ï¸ è¶…æ—¶æœªæ£€æµ‹åˆ°çŠ¶æ€", "warn");

        const exactDate = extractExactExpiry();
        if (exactDate) {
            UI.updateExpiry(exactDate);
            UI.log(`å½“å‰æœŸé™: ${exactDate}`, "info");
        }

        if (STORE.lastRunDate === bjTime.dateStr && !STORE.forceRun) {
            UI.log("âœ… ä»Šæ—¥å·²å®Œæˆï¼Œåœæ­¢ã€‚", "success");
            await wait(3000);
            location.href = CONFIG.LOGIN_URL;
            return;
        }

        UI.log("ğŸ” å¯»æ‰¾æœåŠ¡å™¨å…¥å£...", "step");
        const detailLink = document.querySelector("a[href*='/server/detail?id=']");
        if (detailLink) {
            const foundId = detailLink.href.match(/id=(\d+)/)[1];
            UI.log(`è·³è½¬ ID: ${foundId}`, "info");
            await wait(500);
            detailLink.click();
        } else {
            UI.log("âŒ æœªæ‰¾åˆ°æœåŠ¡å™¨é“¾æ¥", "error");
            const manageBtn = Array.from(document.querySelectorAll("a")).find(el => el.innerText.includes("VPSç®¡ç†"));
            if (manageBtn) manageBtn.click();
        }
    }

    // â‘¢ è¯¦æƒ…é¡µ
    else if (location.href.includes("/server/detail")) {
        UI.log("è¯¦æƒ…é¡µæ£€æŸ¥...", "step");
        await wait(1000);

        if (STORE.lastRunDate === bjTime.dateStr && !STORE.forceRun) {
            UI.log("ä»Šæ—¥å·²å®Œæˆã€‚", "info");
            setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 2000);
            return;
        }

        const exactDate = extractExactExpiry();
        if (exactDate) UI.updateExpiry(exactDate);

        await wait(1000);

        if (document.body.innerText.includes("åˆ©ç”¨æœŸé™ã®1æ—¥å‰ã‹ã‚‰") || document.body.innerText.includes("æ›´æ–°æ‰‹ç¶šããŒå¯èƒ½")) {
            UI.updateResult("âš ï¸ ç»­æœŸç­‰å¾…ï¼");
            UI.log("æç¤º: æœªåˆ°ç»­æœŸæ—¶é—´", "warn");

            const nextDate = extractNextAllowedDate();
            if (nextDate) {
                STORE.nextRunDate = nextDate;
                UI.log(`ğŸ“… é”å®šä¸‹æ¬¡: ${nextDate}`, "info");
            }

            if (STORE.lastRunDate !== bjTime.dateStr) sendTg(`âš ï¸ ç»­æœŸç­‰å¾…ï¼`);
            STORE.lastRunDate = getBeijingDate().dateStr;
            setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
            return;
        }

        const updateBtn = Array.from(document.querySelectorAll("a, button"))
            .find(el => el.innerText.trim() === "æ›´æ–°ã™ã‚‹");
        if (updateBtn) updateBtn.click();
        else UI.log("âš ï¸ æœªæ‰¾åˆ°æ›´æ–°æŒ‰é’®", "warn");
    }

    // â‘£ é€‰æ‹©é¡µ
    else if (location.href.includes("/freevps") && (location.href.includes("/compare") || location.href.includes("/extend/index"))) {
        UI.log("ç¡®è®¤ç»­æœŸé€‰é¡¹...", "step");
        await wait(2000);
        const continueBtn = Array.from(document.querySelectorAll("a, button, input[type='submit']"))
            .find(el => {
                const txt = (el.innerText || el.value || "").replace(/\s/g, "");
                return txt.includes("ç„¡æ–™VPS") && txt.includes("ç¶™ç¶š");
            });
        if (continueBtn) continueBtn.click();
    }

    // â‘¤ éªŒè¯/ç¡®è®¤/æ‰§è¡Œé¡µ
    else if (location.href.includes("/freevps/extend")) {
        UI.log("ğŸŒ¸ è¿›å…¥å¤„ç†æµç¨‹...", "step");
        await wait(1000);

        const newExpiry = extractNewExpiryFromConf();
        if (newExpiry) {
            UI.updateExpiry(newExpiry);
            UI.log(`æ›´æ–°åæœŸé™: ${newExpiry}`, "info");
        }

        if (document.body.innerText.includes("åˆ©ç”¨æœŸé™ã®1æ—¥å‰ã‹ã‚‰") || document.body.innerText.includes("æ›´æ–°æ‰‹ç¶šããŒå¯èƒ½")) {
            UI.updateResult("âš ï¸ ç»­æœŸç­‰å¾…ï¼");
            UI.log("æç¤º: æœªåˆ°ç»­æœŸæ—¶é—´", "warn");

            const nextDate = extractNextAllowedDate();
            if (nextDate) {
                STORE.nextRunDate = nextDate;
                UI.log(`ğŸ“… é”å®šä¸‹æ¬¡: ${nextDate}`, "info");
            }

            if (STORE.lastRunDate !== bjTime.dateStr) sendTg(`âš ï¸ ç»­æœŸç­‰å¾…ï¼`);
            STORE.lastRunDate = getBeijingDate().dateStr;
            setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
            return;
        }

        UI.log("ğŸ” ç­‰å¾…éªŒè¯ç ...", "info");
        let captchaImg = null;
        for (let i = 0; i < 20; i++) {
            captchaImg = document.querySelector("img[src^='data:image']");
            if (captchaImg) break;
            await wait(500);
        }

        if (captchaImg) {
            UI.log("è¯†åˆ«éªŒè¯ç ...", "info");
            const code = await ocrSolve(captchaImg.src);
            if (code && code.length >= 4) {
                const input = document.querySelector("input[type='text']") || document.querySelector("[placeholder*='ä¸Šã®ç”»åƒ']");
                if (input) {
                    input.value = code;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    UI.log(`âœ… å¡«å…¥: ${code}`, "success");
                }
            } else {
                UI.log("âŒ OCRå¤±è´¥", "error");
            }
        } else {
            UI.log("â„¹ï¸ æ— éªŒè¯ç ï¼Œå¯»æ‰¾æŒ‰é’®", "info");
        }

        await wait(1000);

        let loopCount = 0;
        let hasClicked = false;

        const processInterval = setInterval(() => {
            if (hasClicked) { clearInterval(processInterval); return; }
            loopCount++;

            // ğŸŸ¢ CF å¢å¼ºç‚¹å‡»
            const cfSelectors = [
                "iframe[src*='turnstile']",
                ".cf-turnstile",
                "#turnstile-wrapper",
                "div[style*='width: 300px; height: 65px']"
            ];

            if (loopCount % 3 === 0) {
                for (const sel of cfSelectors) {
                    const el = document.querySelector(sel);
                    if (el) { el.click(); break; }
                }
            }

            const inputField = document.querySelector("input[type='text']") || document.querySelector("[placeholder*='ä¸Šã®ç”»åƒ']");
            if (inputField) {
                const currentVal = inputField.value;
                if (!currentVal || currentVal.length < 4) {
                    if (loopCount % 5 === 0) UI.log("â³ ç­‰å¾…å¡«å…¥...", "info");
                    if (loopCount >= 180) {
                         clearInterval(processInterval);
                         UI.log("âŒ è¶…æ—¶åœæ­¢", "error");
                    }
                    return;
                }
            }

            let validSubmitBtn = document.getElementById('submit_button');
            if (!validSubmitBtn) {
                const candidates = Array.from(document.querySelectorAll("input[type='submit'], button, a.btn"));
                validSubmitBtn = candidates.find(el => {
                    const text = (el.value || el.innerText || "").replace(/\s+/g, "");
                    return text.includes("ç¶™ç¶š") ||
                           text.includes("æ›´æ–°") ||
                           text.includes("ç¢ºå®š") ||
                           text.includes("ç„¡æ–™VPS") ||
                           el.classList.contains('btn--primary');
                });
            }

            if (validSubmitBtn) {
                hasClicked = true;
                clearInterval(processInterval);
                UI.log(`ğŸš€ ç‚¹å‡»æäº¤...`, "step");
                validSubmitBtn.style.border = "5px solid green";

                setTimeout(() => {
                    validSubmitBtn.click();
                    UI.log("âœ… ç‚¹å‡»åŠ¨ä½œå®Œæˆ...", "success");
                    // çŠ¶æ€è®¾ä¸ºå¤„ç†ä¸­ï¼Œä½†ä¸å‘TGï¼Œç­‰æˆåŠŸå¼¹çª—
                    UI.updateResult("å¤„ç†ä¸­...");
                }, 300);
            }

            if (loopCount >= 200) clearInterval(processInterval);
        }, 1000);
    }

    // â‘¦ å®Œæˆé¡µ (å¤‡ç”¨)
    else if (location.href.includes("complete") || document.body.innerText.includes("å®Œäº†")) {
         STORE.lastRunDate = getBeijingDate().dateStr;
         UI.updateResult("âœ… ç»­æœŸæˆåŠŸï¼");
         sendTg("âœ… ç»­æœŸæˆåŠŸï¼");
         UI.log("ğŸŒ¸ æµç¨‹ç»“æŸ", "success");
         setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
    }
})();
